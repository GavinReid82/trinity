{% extends "layout.html" %}

{% block title %}Speaking Task 1 - Question {{ question_number }}{% endblock %}

{% block content %}
<h1 class="text-center mb-3">Speaking Task 1 - Question {{ question_number }}</h1>

<div class="card mx-auto mt-4 p-4 shadow" style="max-width: 600px;">
    <p class="text-center fw-bold mb-3">{{ question }}</p>

    <div class="text-center">
        <button id="start-recording" class="btn btn-primary">Start Recording</button>
        <button id="stop-recording" class="btn btn-danger" disabled>Stop Recording</button>
        <button id="countdown-timer" class="btn btn-secondary text-center" disabled style="width: 150px;">
            <span id="countdown-text">30</span> seconds left
        </button>
        
    </div>
</div>


<audio id="audio-player" controls class="mt-3 d-block mx-auto d-none"></audio>


<div class="d-flex justify-content-center mt-5">
    <form method="POST" action="{{ url_for('speaking_task_submit') }}" enctype="multipart/form-data">
        <input type="hidden" name="question_number" value="{{ question_number }}">
        <input type="hidden" name="audio_data" id="audio-data">
        <button type="submit" id="submit-btn" class="btn btn-success mt-3">
            Submit Recording
        </button>        
    </form>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById('start-recording').onclick = async function() {
        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        document.getElementById('start-recording').disabled = true;
        document.getElementById('stop-recording').disabled = false;
        let countdown = 30;
        let interval = setInterval(() => {
            countdown--;
            document.getElementById('countdown-timer').innerText = countdown;
            if (countdown <= 0) {
                mediaRecorder.stop();
                clearInterval(interval);
            }
        }, 1000);

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            let audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            let audioUrl = URL.createObjectURL(audioBlob);
            document.getElementById('audio-player').src = audioUrl;
            let reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = function () {
                document.getElementById('audio-data').value = reader.result;
            };
        };
    };

        document.getElementById('stop-recording').onclick = function() {
            mediaRecorder.stop();
            document.getElementById('start-recording').disabled = false;
            document.getElementById('stop-recording').disabled = true;
    };
        document.querySelector('form').onsubmit = function() {
            let submitBtn = document.getElementById('submit-btn');
            submitBtn.innerText = 'Submitting... Please wait';
            submitBtn.disabled = true; // Disable the button to prevent multiple clicks
    };
    
</script>

{% endblock %}
