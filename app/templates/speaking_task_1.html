{% extends "layout.html" %}

{% block title %}Speaking Task 1 - Question {{ question_number }}{% endblock %}

{% block content %}
<h1 class="text-center">Speaking Task 1 - Question {{ question_number }}</h1>
<p class="text-center">{{ question }}</p>

<div class="text-center">
    <button id="start-recording" class="btn btn-primary">Start Recording</button>
    <button id="stop-recording" class="btn btn-danger" disabled>Stop Recording</button>
    <span id="timer">30</span> seconds left
</div>

<audio id="audio-player" controls class="mt-3 d-block mx-auto"></audio>

<div class="d-flex justify-content-center">
    <form method="POST" action="{{ url_for('speaking_task_submit') }}" enctype="multipart/form-data">
        <input type="hidden" name="question_number" value="{{ question_number }}">
        <input type="hidden" name="audio_data" id="audio-data">
        <button type="submit" class="btn btn-success mt-3">Submit Recording</button>
    </form>
</div>

<script>
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById('start-recording').onclick = async function() {
        let stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.start();
        document.getElementById('start-recording').disabled = true;
        document.getElementById('stop-recording').disabled = false;
        let countdown = 30;
        let interval = setInterval(() => {
            countdown--;
            document.getElementById('timer').innerText = countdown;
            if (countdown <= 0) {
                mediaRecorder.stop();
                clearInterval(interval);
            }
        }, 1000);

        mediaRecorder.ondataavailable = event => {
            audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
            let audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
            let audioUrl = URL.createObjectURL(audioBlob);
            document.getElementById('audio-player').src = audioUrl;
            let reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = function () {
                document.getElementById('audio-data').value = reader.result;
            };
        };
    };

    document.getElementById('stop-recording').onclick = function() {
        mediaRecorder.stop();
        document.getElementById('start-recording').disabled = false;
        document.getElementById('stop-recording').disabled = true;
    };
</script>

{% endblock %}
